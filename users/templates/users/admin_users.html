{% extends "base.html" %}

{% block title %}Admin: User Management{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- Header -->
        <div class="sm:flex sm:items-center sm:justify-between pb-6 border-b border-gray-200">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">User Management</h1>
                <p class="mt-1 text-md text-gray-500">
                    Manage all registered users, roles, and permissions.
                </p>
            </div>
            <div class="mt-4 sm:mt-0">
                <!-- Search Input -->
                <div class="relative">
                    <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input type="text" id="userSearch" class="block w-full sm:w-64 pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search by name or email...">
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tutor Approval</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="userTableBody">
                                {% for profile in users %}
                                <tr class="user-row">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                {% if profile.avatar %}
                                                    <img class="h-10 w-10 rounded-full object-cover" src="{{ profile.avatar.url }}" alt="">
                                                {% else %}
                                                    <span class="inline-block h-10 w-10 rounded-full overflow-hidden bg-gray-100">
                                                        <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                                                        </svg>
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900 searchable-name">{{ profile.user.username }}</div>
                                                <div class="text-sm text-gray-500 searchable-email">{{ profile.user.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ profile.get_role_display }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if profile.user.is_active %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                        {% else %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {% if profile.role == 'TUTOR' %}
                                            {% if profile.is_approved_tutor %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Approved</span>
                                            {% else %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-gray-400">â€”</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                                        <!-- Toggle Status -->
                                        <a href="{% url 'users:toggle_user_status' profile.user.id %}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% if profile.user.is_active %}Deactivate{% else %}Activate{% endif %}
                                        </a>
                                        <!-- Approve Tutor -->
                                        {% if profile.role == 'TUTOR' %}
                                            <a href="{% url 'users:approve_tutor' profile.user.id %}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white {% if profile.is_approved_tutor %}bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500{% else %}bg-green-600 hover:bg-green-700 focus:ring-green-500{% endif %} focus:outline-none focus:ring-2 focus:ring-offset-2">
                                                {% if profile.is_approved_tutor %}Revoke{% else %}Approve{% endif %}
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('userSearch').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let tableBody = document.getElementById('userTableBody');
        let rows = tableBody.getElementsByClassName('user-row');

        for (let i = 0; i < rows.length; i++) {
            let name = rows[i].getElementsByClassName('searchable-name')[0].textContent.toLowerCase();
            let email = rows[i].getElementsByClassName('searchable-email')[0].textContent.toLowerCase();
            if (name.includes(filter) || email.includes(filter)) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    });
</script>
{% endblock %}
