{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}My Submissions | {{ problem.title }} | MockMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  .status-accepted { @apply bg-emerald-50 text-emerald-800 border-emerald-200; }
  .status-wrong { @apply bg-rose-50 text-rose-800 border-rose-200; }
  .status-tle { @apply bg-orange-50 text-orange-800 border-orange-200; }
  .status-error { @apply bg-red-50 text-red-800 border-red-200; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
  <div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-4">
          <a href="{% url 'practice:problem_detail' problem.slug %}" 
             class="text-gray-500 hover:text-gray-700 transition duration-200">
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">My Submissions</h1>
            <p class="text-gray-600 mt-1">
              Problem: <a href="{% url 'practice:problem_detail' problem.slug %}" 
                         class="text-blue-600 font-semibold hover:underline">{{ problem.title }}</a>
            </p>
          </div>
        </div>

        <div class="flex items-center space-x-3">
          <a href="{% url 'practice:problem_detail' problem.slug %}"
             class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
            <i class="fas fa-code mr-2"></i>
            Back to Problem
          </a>
        </div>
      </div>

      <!-- Problem Info -->
      <div class="flex flex-wrap items-center gap-4">
        <span class="px-3 py-1 rounded-full text-sm font-semibold
          {% if problem.difficulty == 'EASY' %}bg-emerald-100 text-emerald-800
          {% elif problem.difficulty == 'MEDIUM' %}bg-amber-100 text-amber-800
          {% elif problem.difficulty == 'HARD' %}bg-rose-100 text-rose-800
          {% else %}bg-gray-100 text-gray-800{% endif %}">
          {{ problem.get_difficulty_display }}
        </span>

        {% if problem.category %}
          <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
            <i class="fas fa-tag mr-1"></i>{{ problem.category.name }}
          </span>
        {% endif %}

        {% if problem.companies %}
          <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-purple-100 text-purple-800">
            <i class="fas fa-building mr-1"></i>{{ problem.companies }}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Statistics Panel -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-paper-plane text-blue-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Total Submissions</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.total_submissions }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-check-circle text-emerald-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Accepted</p>
            <p class="text-2xl font-bold text-emerald-600">{{ stats.accepted_submissions }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-star text-yellow-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Best Score</p>
            <p class="text-2xl font-bold text-yellow-600">{{ stats.best_score }}%</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-stopwatch text-purple-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Avg Runtime</p>
            <p class="text-2xl font-bold text-purple-600">{{ stats.average_runtime|floatformat:2 }}s</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Submissions List -->
    <div class="bg-white rounded-xl shadow-lg">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-gray-900">Submission History</h2>
          <div class="text-sm text-gray-500">
            Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }} submissions
          </div>
        </div>
      </div>

      {% if page_obj %}
        <div class="divide-y divide-gray-200">
          {% for submission in page_obj %}
            <div class="submission-item" data-submission-id="{{ submission.id }}">
              <div class="p-6 hover:bg-gray-50 transition duration-200">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleSubmissionDetails('{{ submission.id }}')">
                  <div class="flex items-center space-x-4">
                    <!-- Status Icon -->
                    <div class="w-10 h-10 rounded-full flex items-center justify-center
                      {% if submission.status == 'ACCEPTED' %}bg-emerald-100
                      {% elif submission.status == 'WRONG_ANSWER' %}bg-rose-100
                      {% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}bg-orange-100
                      {% elif submission.status == 'MEMORY_LIMIT_EXCEEDED' %}bg-red-100
                      {% elif submission.status == 'RUNTIME_ERROR' %}bg-red-100
                      {% elif submission.status == 'COMPILATION_ERROR' %}bg-red-100
                      {% else %}bg-gray-100{% endif %}">
                      {% if submission.status == 'ACCEPTED' %}
                        <i class="fas fa-check text-emerald-600"></i>
                      {% elif submission.status == 'WRONG_ANSWER' %}
                        <i class="fas fa-times text-rose-600"></i>
                      {% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}
                        <i class="fas fa-clock text-orange-600"></i>
                      {% elif submission.status == 'MEMORY_LIMIT_EXCEEDED' %}
                        <i class="fas fa-memory text-red-600"></i>
                      {% elif submission.status == 'RUNTIME_ERROR' %}
                        <i class="fas fa-bug text-red-600"></i>
                      {% elif submission.status == 'COMPILATION_ERROR' %}
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                      {% else %}
                        <i class="fas fa-question text-gray-600"></i>
                      {% endif %}
                    </div>

                    <div>
                      <div class="flex items-center space-x-3">
                        <span class="px-3 py-1 rounded-full text-sm font-medium border
                          {% if submission.status == 'ACCEPTED' %}status-accepted
                          {% elif submission.status == 'WRONG_ANSWER' %}status-wrong
                          {% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}status-tle
                          {% elif submission.status == 'MEMORY_LIMIT_EXCEEDED' %}status-error
                          {% elif submission.status == 'RUNTIME_ERROR' %}status-error
                          {% elif submission.status == 'COMPILATION_ERROR' %}status-error
                          {% else %}bg-gray-100 text-gray-800 border-gray-200{% endif %}">
                          {{ submission.get_status_display|replace:"_":" "|title }}
                        </span>
                        
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded-md text-xs font-medium">
                          {{ submission.get_language_display }}
                        </span>

                        {% if submission.score %}
                          <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-md text-xs font-medium">
                            {{ submission.score }}/{{ submission.max_score }}
                          </span>
                        {% endif %}
                      </div>

                      <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                        <span>
                          <i class="far fa-clock mr-1"></i>
                          {{ submission.submission_time|date:"M d, Y H:i" }}
                        </span>
                        
                        {% if submission.total_runtime %}
                          <span>
                            <i class="fas fa-stopwatch mr-1"></i>
                            {{ submission.total_runtime|floatformat:3 }}s
                          </span>
                        {% endif %}

                        {% if submission.peak_memory %}
                          <span>
                            <i class="fas fa-memory mr-1"></i>
                            {{ submission.peak_memory|floatformat:1 }} KB
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>

                  <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-500">
                      {{ submission.submission_time|timesince }} ago
                    </span>
                    <i id="arrow-{{ submission.id }}" class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                  </div>
                </div>

                <!-- Expandable Details -->
                <div id="details-{{ submission.id }}" class="hidden mt-6 border-t border-gray-200 pt-6">
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Code Section -->
                    <div class="lg:col-span-2">
                      <h3 class="text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-code mr-2"></i>Submitted Code
                      </h3>
                      <div class="bg-gray-900 rounded-lg overflow-hidden">
                        <div class="bg-gray-800 px-4 py-2 text-sm text-gray-300 font-mono">
                          {{ submission.get_language_display }}
                        </div>
                        <pre class="p-4 text-sm text-gray-100 overflow-x-auto"><code>{{ submission.code }}</code></pre>
                      </div>
                    </div>

                    <!-- Execution Details -->
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-info-circle mr-2"></i>Execution Details
                      </h3>
                      
                      <div class="space-y-3">
                        <div class="bg-gray-50 p-3 rounded-lg">
                          <div class="text-sm font-medium text-gray-600">Status</div>
                          <div class="text-lg font-semibold
                            {% if submission.status == 'ACCEPTED' %}text-emerald-600
                            {% elif submission.status == 'WRONG_ANSWER' %}text-rose-600
                            {% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}text-orange-600
                            {% elif submission.status == 'MEMORY_LIMIT_EXCEEDED' %}text-red-600
                            {% elif submission.status == 'RUNTIME_ERROR' %}text-red-600
                            {% elif submission.status == 'COMPILATION_ERROR' %}text-red-600
                            {% else %}text-red-600{% endif %}">
                            {{ submission.get_status_display|replace:"_":" "|title }}
                          </div>
                        </div>

                        {% if submission.score %}
                          <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm font-medium text-gray-600">Score</div>
                            <div class="text-lg font-semibold text-blue-600">
                              {{ submission.score }} / {{ submission.max_score }}
                              ({{ submission.score|mul:100|div:submission.max_score|floatformat:1 }}%)
                            </div>
                          </div>
                        {% endif %}

                        {% if submission.total_runtime %}
                          <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm font-medium text-gray-600">Runtime</div>
                            <div class="text-lg font-semibold text-purple-600">
                              {{ submission.total_runtime|floatformat:3 }}s
                            </div>
                          </div>
                        {% endif %}

                        {% if submission.peak_memory %}
                          <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-sm font-medium text-gray-600">Memory</div>
                            <div class="text-lg font-semibold text-indigo-600">
                              {{ submission.peak_memory|floatformat:1 }} KB
                            </div>
                          </div>
                        {% endif %}
                      </div>

                      {% if submission.error_message %}
                        <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                          <div class="text-sm font-medium text-red-800 mb-2">Error Message</div>
                          <div class="text-sm text-red-700 font-mono">{{ submission.error_message }}</div>
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Test Results -->
                  {% if submission.test_results %}
                    <div class="mt-6">
                      <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-vial mr-2"></i>Test Results
                      </h3>
                      
                      <div class="space-y-3">
                        {% for test_result in submission.test_results %}
                          <div class="border rounded-lg overflow-hidden
                            {% if test_result.status == 'PASS' %}border-emerald-200
                            {% else %}border-rose-200{% endif %}">
                            
                            <div class="px-4 py-3 
                              {% if test_result.status == 'PASS' %}bg-emerald-50
                              {% else %}bg-rose-50{% endif %}">
                              <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                  {% if test_result.status == 'PASS' %}
                                    <i class="fas fa-check-circle text-emerald-500"></i>
                                  {% else %}
                                    <i class="fas fa-times-circle text-rose-500"></i>
                                  {% endif %}
                                  <span class="font-medium text-gray-800">
                                    Test Case {{ forloop.counter }}
                                  </span>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-medium
                                  {% if test_result.status == 'PASS' %}bg-emerald-100 text-emerald-800
                                  {% else %}bg-rose-100 text-rose-800{% endif %}">
                                  {{ test_result.status|replace:"_":" "|title }}
                                </span>
                              </div>
                            </div>

                            <div class="p-4 bg-white space-y-3">
                              {% if test_result.input and test_result.input != 'Hidden' %}
                                <div>
                                  <div class="text-sm font-medium text-gray-600 mb-1">Input:</div>
                                  <div class="bg-gray-100 p-2 rounded text-sm font-mono overflow-x-auto">{{ test_result.input }}</div>
                                </div>
                              {% endif %}

                              {% if test_result.expected_output and test_result.expected_output != 'Hidden' %}
                                <div>
                                  <div class="text-sm font-medium text-gray-600 mb-1">Expected Output:</div>
                                  <div class="bg-gray-100 p-2 rounded text-sm font-mono overflow-x-auto">{{ test_result.expected_output }}</div>
                                </div>
                              {% endif %}

                              <div>
                                <div class="text-sm font-medium text-gray-600 mb-1">Your Output:</div>
                                <div class="bg-gray-100 p-2 rounded text-sm font-mono overflow-x-auto">{{ test_result.actual_output }}</div>
                              </div>

                              {% if test_result.error %}
                                <div>
                                  <div class="text-sm font-medium text-red-600 mb-1">Error:</div>
                                  <div class="bg-red-50 border border-red-200 p-2 rounded text-sm font-mono text-red-700">{{ test_result.error }}</div>
                                </div>
                              {% endif %}

                              <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                  <span>
                                    <i class="fas fa-stopwatch mr-1"></i>
                                    {{ test_result.cpuTime|default:"N/A" }}s
                                  </span>
                                  <span>
                                    <i class="fas fa-memory mr-1"></i>
                                    {{ test_result.memory|default:"N/A" }} KB
                                  </span>
                                </div>
                                {% if test_result.difficulty_weight %}
                                  <div class="text-xs text-gray-500">
                                    Weight: {{ test_result.difficulty_weight }}
                                  </div>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
          <div class="p-6 border-t border-gray-200 bg-gray-50">
            <nav class="flex items-center justify-between">
              <div class="flex items-center">
                <p class="text-sm text-gray-700">
                  Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} submissions
                </p>
              </div>
              
              <div class="flex items-center space-x-2">
                {% if page_obj.has_previous %}
                  <a href="?page={{ page_obj.previous_page_number }}"
                     class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition duration-200">
                    <i class="fas fa-chevron-left mr-1"></i>Previous
                  </a>
                {% endif %}

                <div class="hidden md:flex space-x-1">
                  {% for page_num in page_obj.paginator.page_range %}
                    {% if page_num == page_obj.number %}
                      <span class="px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg">
                        {{ page_num }}
                      </span>
                    {% elif page_num > page_obj.number|add:-3 and page_num < page_obj.number|add:3 %}
                      <a href="?page={{ page_num }}"
                         class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition duration-200">
                        {{ page_num }}
                      </a>
                    {% endif %}
                  {% endfor %}
                </div>

                {% if page_obj.has_next %}
                  <a href="?page={{ page_obj.next_page_number }}"
                     class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition duration-200">
                    Next<i class="fas fa-chevron-right ml-1"></i>
                  </a>
                {% endif %}
              </div>
            </nav>
          </div>
        {% endif %}

      {% else %}
        <div class="p-12 text-center">
          <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
            <i class="fas fa-code text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No submissions yet</h3>
          <p class="text-gray-500 mb-6">You haven't made any submissions for this problem yet.</p>
          <a href="{% url 'practice:problem_detail' problem.slug %}"
             class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
            <i class="fas fa-code mr-2"></i>
            Start Coding
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function toggleSubmissionDetails(submissionId) {
    const detailsDiv = document.getElementById(`details-${submissionId}`);
    const arrowIcon = document.getElementById(`arrow-${submissionId}`);

    if (detailsDiv.classList.contains('hidden')) {
      detailsDiv.classList.remove('hidden');
      arrowIcon.classList.add('rotate-180');
    } else {
      detailsDiv.classList.add('hidden');
      arrowIcon.classList.remove('rotate-180');
    }
  }

  // Auto-expand the latest submission if there's only one
  document.addEventListener('DOMContentLoaded', function() {
    const submissions = document.querySelectorAll('.submission-item');
    if (submissions.length === 1) {
      const submissionId = submissions[0].dataset.submissionId;
      toggleSubmissionDetails(submissionId);
    }
  });
</script>
{% endblock %}
