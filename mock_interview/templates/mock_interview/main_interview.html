{% extends "base.html" %}
{% load static %}
{% load form_filters %}
{% block title %}AI Mock Interview | MockMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          primary: {
            50: '#eff6ff',
            500: '#3b82f6',
            600: '#2563eb',
            700: '#1d4ed8',
            900: '#1e3a8a'
          },
          glass: 'rgba(255, 255, 255, 0.08)',
          'glass-border': 'rgba(255, 255, 255, 0.12)'
        },
        backdropBlur: {
          'xs': '2px',
        }
      }
    }
  }
</script>
<style>
  /* Custom animations and glass effects */
  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
    70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
  }
  
  @keyframes listening-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
  }
  
  @keyframes typing-bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-8px); }
  }
  
  .pulse-ring { animation: pulse-ring 2s infinite; }
  .listening-pulse { animation: listening-pulse 1.5s infinite; }
  .typing-dot { animation: typing-bounce 1.4s ease-in-out infinite; }
  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  
  .glass-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.12);
  }
  
  .gradient-bg {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
  }
  
  /* Custom scrollbar */
  .custom-scrollbar::-webkit-scrollbar { width: 8px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: rgba(148, 163, 184, 0.1); }
  .custom-scrollbar::-webkit-scrollbar-thumb { 
    background: rgba(148, 163, 184, 0.4); 
    border-radius: 4px; 
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.6); }
  
  /* Volume slider custom styling */
  .volume-slider {
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background: rgba(148, 163, 184, 0.3);
    border-radius: 3px;
    outline: none;
  }
  
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
    transition: all 0.2s ease;
  }
  
  .volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.6);
  }
  
  .volume-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: #3b82f6;
    border-radius: 50%;
    border: none;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen gradient-bg text-white">
  <!-- Header Section -->
  <div class="bg-black/20 backdrop-blur-sm border-b border-white/10 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo and Title -->
        <div class="flex items-center space-x-4">
          <div class="relative w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
            <i class="fas fa-user-graduate text-xl text-white"></i>
            <div id="header-status" class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white pulse-ring"></div>
          </div>
          <div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
              AI Mock Interview
            </h1>
            <p class="text-sm text-gray-300">{{ job_role }}</p>
          </div>
        </div>
        
        <!-- Progress Indicators -->
        <div class="hidden md:flex items-center space-x-8">
          <div class="text-center">
            <div class="w-16 h-16 relative">
              <svg class="w-full h-full transform -rotate-90">
                <circle cx="32" cy="32" r="28" stroke="rgba(148, 163, 184, 0.2)" stroke-width="3" fill="none"/>
                <circle id="question-progress" cx="32" cy="32" r="28" stroke="#3b82f6" stroke-width="3" 
                        fill="none" stroke-dasharray="0 176" stroke-linecap="round" class="transition-all duration-500"/>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="question-counter" class="text-lg font-bold">1</span>
              </div>
            </div>
            <p class="text-xs text-gray-400 mt-2 font-medium">QUESTION</p>
          </div>
          
          <div class="text-center">
            <div class="w-16 h-16 relative">
              <svg class="w-full h-full transform -rotate-90">
                <circle cx="32" cy="32" r="28" stroke="rgba(148, 163, 184, 0.2)" stroke-width="3" fill="none"/>
                <circle id="time-progress" cx="32" cy="32" r="28" stroke="#10b981" stroke-width="3" 
                        fill="none" stroke-dasharray="0 176" stroke-linecap="round" class="transition-all duration-500"/>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="timer-display" class="text-sm font-bold">00:00</span>
              </div>
            </div>
            <p class="text-xs text-gray-400 mt-2 font-medium">TIME</p>
          </div>
        </div>
        
        <!-- Interview Status -->
        <div id="interview-status" class="glass-card px-4 py-2 rounded-full flex items-center space-x-2 text-sm font-medium">
          <div class="w-3 h-3 bg-green-500 rounded-full pulse-ring"></div>
          <span>Ready to Start</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
      
      <!-- Left Column - Video & Controls -->
      <div class="xl:col-span-1 space-y-6">
        
        <!-- Video Section -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="p-4 border-b border-white/10">
            <h3 class="text-lg font-semibold flex items-center space-x-2">
              <i class="fas fa-video text-blue-400"></i>
              <span>Your Camera</span>
            </h3>
          </div>
          <div class="relative aspect-video bg-gray-900">
            <video id="user-video" autoplay playsinline muted class="w-full h-full object-cover"></video>
            <div id="video-overlay" class="absolute inset-0 bg-gradient-to-br from-gray-900/90 to-blue-900/90 flex items-center justify-center">
              <div class="text-center">
                <div class="w-20 h-20 bg-white/10 rounded-2xl flex items-center justify-center mb-4 mx-auto backdrop-blur-sm">
                  <i class="fas fa-camera text-3xl text-white"></i>
                </div>
                <h4 class="text-xl font-bold mb-2">Camera Setup</h4>
                <p class="text-gray-300 max-w-xs">Allow camera and microphone access to begin your professional interview</p>
              </div>
            </div>
            <div id="recording-indicator" class="absolute top-4 right-4 bg-red-500 text-white px-3 py-2 rounded-full text-sm font-bold flex items-center space-x-2 hidden">
              <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
              <span>REC</span>
            </div>
          </div>
        </div>
        
        <!-- AI Interviewer -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="p-4 border-b border-white/10">
            <h3 class="text-lg font-semibold flex items-center space-x-2">
              <div class="relative">
                <i class="fas fa-robot text-purple-400"></i>
                <div id="ai-status-dot" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border border-white"></div>
              </div>
              <span>Sarah - AI Interviewer</span>
            </h3>
          </div>
          <div class="relative aspect-video bg-gradient-to-br from-gray-900 to-purple-900">
            <canvas id="ai-visualizer-canvas" class="absolute inset-0 w-full h-full"></canvas>
            <div class="absolute inset-0 flex items-center justify-center">
              <div id="ai-avatar" class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/30 transition-all duration-300">
                <i class="fas fa-user-tie text-3xl text-white"></i>
              </div>
            </div>
            <div id="ai-status-text" class="absolute top-4 left-4 bg-black/40 text-white px-3 py-2 rounded-lg text-sm backdrop-blur-sm">
              <i class="fas fa-brain mr-2"></i>
              <span>Ready to Interview</span>
            </div>
            <button id="hints-btn" class="absolute top-4 right-4 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 px-3 py-2 rounded-lg text-sm font-medium backdrop-blur-sm border border-yellow-400/30 transition-all duration-200 hidden">
              <i class="fas fa-lightbulb mr-2"></i>
              <span>Get Hints</span>
            </button>
          </div>
        </div>
        
        <!-- Session Info -->
        <div class="glass-card rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center space-x-2">
            <i class="fas fa-clipboard-list text-green-400"></i>
            <span>Session Details</span>
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-400">Role:</span>
              <span class="font-semibold">{{ job_role }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Duration:</span>
              <span class="font-semibold">20-25 min</span>
            </div>
            <div class="border-t border-white/10 pt-3">
              <p class="text-gray-400 text-sm mb-2">Key Skills:</p>
              <div class="flex flex-wrap gap-2">
                {% for skill in key_skills|split:"," %}
                  <span class="bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full text-sm border border-blue-400/30">
                    {{ skill|trim_whitespace }}
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
          
          <!-- Volume Control -->
          <div class="mt-6 pt-4 border-t border-white/10">
            <div class="flex items-center space-x-3 mb-3">
              <i class="fas fa-volume-up text-gray-400"></i>
              <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.8" 
                     class="flex-1 volume-slider cursor-pointer">
              <span id="volume-display" class="text-sm font-medium w-12">80%</span>
            </div>
            <button id="test-audio-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-volume-up mr-2"></i>Test Audio
            </button>
          </div>
        </div>
      </div>
      
      <!-- Center Column - Chat -->
      <div class="xl:col-span-1">
        <div class="glass-card rounded-2xl h-[700px] flex flex-col">
          <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h3 class="text-lg font-semibold flex items-center space-x-2">
              <i class="fas fa-comments text-blue-400"></i>
              <span>Interview Conversation</span>
            </h3>
            <div id="chat-progress" class="hidden flex items-center space-x-4 text-sm">
              <div class="text-center">
                <div id="response-count" class="text-xl font-bold text-blue-400">0</div>
                <div class="text-xs text-gray-400">Responses</div>
              </div>
              <div class="text-center">
                <div id="avg-length" class="text-xl font-bold text-green-400">0</div>
                <div class="text-xs text-gray-400">Avg Words</div>
              </div>
            </div>
          </div>
          
          <div id="chat-messages" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <div id="chat-empty" class="h-full flex flex-col items-center justify-center text-center">
              <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-comment-dots text-2xl text-blue-400"></i>
              </div>
              <h4 class="text-xl font-bold mb-2">Ready to Begin</h4>
              <p class="text-gray-400 max-w-sm">Your conversation with Sarah will appear here once you start the interview</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column - Controls -->
      <div class="xl:col-span-1 space-y-6">
        
        <!-- Interview Controls -->
        <div class="glass-card rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-6 flex items-center space-x-2">
            <i class="fas fa-gamepad text-green-400"></i>
            <span>Interview Controls</span>
          </h3>
          
          <div class="space-y-4">
            <button id="start-interview-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-4 px-6 rounded-xl text-lg font-bold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
              <i class="fas fa-play mr-2"></i>
              <span>Start Interview</span>
            </button>
            
            <div class="grid grid-cols-2 gap-3">
              <button id="pause-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors hidden">
                <i class="fas fa-pause mr-2"></i>Pause
              </button>
              <button id="end-interview-btn" class="bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                <i class="fas fa-stop mr-2"></i>End
              </button>
            </div>
          </div>
        </div>
        
        <!-- Speech Controls -->
        <div class="glass-card rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-6 flex items-center space-x-2">
            <i class="fas fa-microphone text-purple-400"></i>
            <span>Voice Response</span>
          </h3>
          
          <div class="space-y-4">
            <button id="speak-button" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl text-lg font-bold transition-all duration-200 transform hover:scale-105 shadow-lg relative overflow-hidden" disabled>
              <i class="fas fa-microphone mr-2"></i>
              <span id="speak-button-text">Press to Speak</span>
              <div id="listening-animation" class="hidden absolute inset-0 flex items-center justify-center">
                <div class="flex space-x-1">
                  <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                  <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                  <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                </div>
              </div>
            </button>
            
            <div class="grid grid-cols-2 gap-3">
              <button id="stop-speaking-btn" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium transition-colors hidden">
                <i class="fas fa-stop mr-2"></i>Stop
              </button>
              <button id="skip-question-btn" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium transition-colors hidden">
                <i class="fas fa-forward mr-2"></i>Skip
              </button>
            </div>
            
            <!-- Status Display -->
            <div id="stt-status" class="glass-card p-4 rounded-lg flex items-center space-x-3 text-sm">
              <i class="fas fa-info-circle text-blue-400"></i>
              <span>Click "Start Interview" to begin your session</span>
            </div>
            
            <!-- Confidence Meter -->
            <div id="confidence-meter" class="hidden glass-card p-4 rounded-lg">
              <div class="flex justify-between items-center mb-3">
                <span class="text-sm font-medium">Speech Clarity</span>
                <span id="confidence-percentage" class="text-sm font-bold text-green-400">0%</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div id="confidence-bar" class="bg-gradient-to-r from-red-400 via-yellow-400 to-green-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hints Modal -->
<div id="hints-modal" class="fixed inset-0 z-50 hidden">
  <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" onclick="hideHintsModal()"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="glass-card rounded-2xl p-8 max-w-2xl w-full max-h-[80vh] overflow-y-auto custom-scrollbar transform scale-95 opacity-0 transition-all duration-300" id="hints-modal-content">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-lightbulb text-2xl text-yellow-400"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2">Interview Guidance</h3>
        <p class="text-gray-400">Strategic tips to help you excel with the current question</p>
      </div>
      <div id="hints-content" class="space-y-4 mb-8">
        <!-- Hints will be loaded here -->
      </div>
      <div class="flex justify-center space-x-4">
        <button onclick="hideHintsModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
          <i class="fas fa-check mr-2"></i>Got It, Thanks!
        </button>
        <button onclick="hideHintsModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
          <i class="fas fa-times mr-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden">
  <div class="text-center">
    <div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
    <div id="loading-text" class="text-xl font-semibold text-white">Initializing AI Interview...</div>
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-4 max-w-sm"></div>

<!-- Hidden Audio Element -->
<audio id="ai-audio-element" preload="auto" crossorigin="anonymous" class="hidden"></audio>

<script>
// Enhanced MockMate Interview System
const SESSION_ID = {{ session_id }};
const CSRF_TOKEN = "{{ csrf_token }}";
const INITIAL_CHAT = JSON.parse('{{ initial_chat_history_json|escapejs }}' || "[]");
const INTERVIEW_PROGRESS = JSON.parse('{{ interview_progress|escapejs }}');

// Enhanced DOM Elements
const elements = {
  // Chat and messaging
  chatMessages: document.getElementById('chat-messages'),
  chatEmpty: document.getElementById('chat-empty'),
  chatProgress: document.getElementById('chat-progress'),
  responseCount: document.getElementById('response-count'),
  avgLength: document.getElementById('avg-length'),
  
  // Status indicators
  interviewStatus: document.getElementById('interview-status'),
  sttStatus: document.getElementById('stt-status'),
  headerStatus: document.getElementById('header-status'),
  aiStatusDot: document.getElementById('ai-status-dot'),
  aiStatusText: document.getElementById('ai-status-text'),
  
  // Control buttons
  startBtn: document.getElementById('start-interview-btn'),
  endBtn: document.getElementById('end-interview-btn'),
  pauseBtn: document.getElementById('pause-btn'),
  speakBtn: document.getElementById('speak-button'),
  speakBtnText: document.getElementById('speak-button-text'),
  stopSpeakBtn: document.getElementById('stop-speaking-btn'),
  skipBtn: document.getElementById('skip-question-btn'),
  hintsBtn: document.getElementById('hints-btn'),
  testAudioBtn: document.getElementById('test-audio-btn'),
  
  // Video and audio
  userVideo: document.getElementById('user-video'),
  videoOverlay: document.getElementById('video-overlay'),
  recordingIndicator: document.getElementById('recording-indicator'),
  aiAudioElement: document.getElementById('ai-audio-element'),
  volumeSlider: document.getElementById('volume-slider'),
  volumeDisplay: document.getElementById('volume-display'),
  
  // Visualizer and avatar
  visualizerCanvas: document.getElementById('ai-visualizer-canvas'),
  aiAvatar: document.getElementById('ai-avatar'),
  
  // Progress indicators
  questionCounter: document.getElementById('question-counter'),
  timerDisplay: document.getElementById('timer-display'),
  questionProgress: document.getElementById('question-progress'),
  timeProgress: document.getElementById('time-progress'),
  
  // Confidence meter
  confidenceMeter: document.getElementById('confidence-meter'),
  confidenceBar: document.getElementById('confidence-bar'),
  confidencePercentage: document.getElementById('confidence-percentage'),
  
  // Modals and overlays
  hintsModal: document.getElementById('hints-modal'),
  hintsModalContent: document.getElementById('hints-modal-content'),
  hintsContent: document.getElementById('hints-content'),
  loadingOverlay: document.getElementById('loading-overlay'),
  loadingText: document.getElementById('loading-text'),
  notificationContainer: document.getElementById('notification-container'),
  
  // Animations
  listeningAnimation: document.getElementById('listening-animation')
};

// Enhanced State Management
let state = {
  sessionId: SESSION_ID,
  currentQuestion: INTERVIEW_PROGRESS.total_questions || 1,
  startTime: null,
  isPaused: false,
  isInitialized: false,
  interviewActive: false,
  interviewComplete: false,
  
  mediaStream: null,
  isListening: false,
  isPlaying: false,
  audioQueue: [],
  audioCtx: null,
  analyser: null,
  recognition: null,
  currentVolume: 0.8,
  
  chatHistory: [...INITIAL_CHAT],
  lastUserResponse: '',
  awaitingResponse: false,
  totalResponses: 0,
  totalWords: 0,
  
  visualizerAnimationId: null,
  currentConfidence: 0,
  lastUpdateTime: 0,
  progressTimer: null,
  
  consecutiveErrors: 0,
  lastErrorTime: 0,
  maxRetries: 3
};

// Utility Functions
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Progress Updates
function updateProgress() {
  if (state.startTime) {
    const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
    elements.timerDisplay.textContent = formatTime(elapsed);
    
    const timeProgress = Math.min((elapsed / 1200) * 100, 100);
    const questionProgress = Math.min((state.currentQuestion / 12) * 100, 100);
    
    updateCircularProgress(elements.timeProgress, timeProgress);
    updateCircularProgress(elements.questionProgress, questionProgress);
    
    if (state.totalResponses > 0) {
      elements.responseCount.textContent = state.totalResponses;
      elements.avgLength.textContent = Math.round(state.totalWords / state.totalResponses);
      elements.chatProgress.classList.remove('hidden');
    }
  }
  
  elements.questionCounter.textContent = state.currentQuestion.toString();
}

function updateCircularProgress(circle, percentage) {
  const circumference = 176;
  const offset = circumference - (percentage / 100) * circumference;
  circle.style.strokeDasharray = `${circumference} ${circumference}`;
  circle.style.strokeDashoffset = offset;
}

// Notification System
function showNotification(message, type = 'info', duration = 5000) {
  const notification = document.createElement('div');
  
  const bgColors = {
    success: 'bg-green-500/20 border-green-400/30 text-green-300',
    error: 'bg-red-500/20 border-red-400/30 text-red-300',
    warning: 'bg-yellow-500/20 border-yellow-400/30 text-yellow-300',
    info: 'bg-blue-500/20 border-blue-400/30 text-blue-300'
  };
  
  const icons = {
    success: 'fas fa-check-circle',
    error: 'fas fa-exclamation-triangle',
    warning: 'fas fa-exclamation-circle',
    info: 'fas fa-info-circle'
  };
  
  notification.className = `glass-card ${bgColors[type]} border rounded-lg p-4 flex items-start space-x-3 transform translate-x-full transition-transform duration-300`;
  
  notification.innerHTML = `
    <i class="${icons[type]} text-lg mt-0.5"></i>
    <div class="flex-1 font-medium">${message}</div>
    <button onclick="this.closest('div').remove()" class="text-current opacity-70 hover:opacity-100">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  elements.notificationContainer.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.remove('translate-x-full');
  }, 100);
  
  if (duration > 0) {
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }
  
  return notification;
}

// Status Updates
function updateInterviewStatus(status, statusClass = 'bg-green-500') {
  const statusElement = elements.interviewStatus;
  statusElement.innerHTML = `
    <div class="w-3 h-3 ${statusClass} rounded-full pulse-ring"></div>
    <span>${status}</span>
  `;
}

function updateSpeechStatus(message, type = 'info') {
  const typeClasses = {
    info: 'text-blue-400',
    success: 'text-green-400',
    error: 'text-red-400',
    warning: 'text-yellow-400'
  };
  
  const icons = {
    info: 'fas fa-info-circle',
    success: 'fas fa-check-circle',
    error: 'fas fa-exclamation-triangle',
    warning: 'fas fa-exclamation-circle'
  };
  
  elements.sttStatus.innerHTML = `
    <i class="${icons[type]} ${typeClasses[type]}"></i>
    <span>${message}</span>
  `;
}

// Audio Functions
function updateVolume() {
  const volume = parseFloat(elements.volumeSlider.value);
  state.currentVolume = volume;
  elements.volumeDisplay.textContent = Math.round(volume * 100) + '%';
  elements.aiAudioElement.volume = volume;
}

async function testAudio() {
  try {
    showLoadingOverlay('Testing audio system...');
    
    const response = await fetch('/mock-interview/api/health/', {
      method: 'GET',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json',
      }
    });
    
    const healthData = await response.json();
    hideLoadingOverlay();
    
    if (healthData.text_generation && healthData.tts_functional) {
      showNotification('Audio system is working perfectly!', 'success');
    } else {
      showNotification('Audio system has limited functionality. Some features may not work optimally.', 'warning', 8000);
    }
  } catch (error) {
    hideLoadingOverlay();
    console.error('Audio test failed:', error);
    showNotification('Audio test failed. Please check your connection and try again.', 'error');
  }
}

// Media Setup
async function setupMediaDevices() {
  try {
    showLoadingOverlay('Setting up camera and microphone...');
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: 'user'
      },
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    });
    
    state.mediaStream = stream;
    elements.userVideo.srcObject = stream;
    elements.videoOverlay.classList.add('hidden');
    
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      state.recognition = new SpeechRecognition();
      
      state.recognition.continuous = true;
      state.recognition.interimResults = true;
      state.recognition.lang = 'en-US';
      state.recognition.maxAlternatives = 1;
      
      setupSpeechRecognitionHandlers();
      updateSpeechStatus('Voice recognition ready', 'success');
    } else {
      updateSpeechStatus('Voice recognition not supported in this browser', 'warning');
    }
    
    hideLoadingOverlay();
    showNotification('Camera and microphone setup completed successfully!', 'success');
    return true;
    
  } catch (error) {
    hideLoadingOverlay();
    console.error('Media setup failed:', error);
    
    let errorMessage = 'Failed to access camera and microphone. ';
    if (error.name === 'NotAllowedError') {
      errorMessage += 'Please allow camera and microphone access and refresh the page.';
    } else if (error.name === 'NotFoundError') {
      errorMessage += 'No camera or microphone found.';
    } else {
      errorMessage += 'Please check your devices and try again.';
    }
    
    showNotification(errorMessage, 'error', 10000);
    return false;
  }
}

// Speech Recognition Handlers
function setupSpeechRecognitionHandlers() {
  if (!state.recognition) return;
  
  let speechBuffer = '';
  let lastSpeechTime = 0;
  let silenceTimer = null;
  
  state.recognition.onstart = () => {
    state.isListening = true;
    elements.speakBtn.classList.add('listening-pulse');
    elements.listeningAnimation.classList.remove('hidden');
    elements.speakBtnText.classList.add('hidden');
    updateSpeechStatus('Listening for your response...', 'info');
    updateInterviewStatus('Listening', 'bg-red-500');
  };
  
  state.recognition.onresult = (event) => {
    let interimTranscript = '';
    let finalTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }
    
    if (finalTranscript) {
      speechBuffer += finalTranscript;
      lastSpeechTime = Date.now();
      
      const confidence = event.results[event.results.length - 1][0].confidence;
      if (confidence) {
        updateConfidenceMeter(confidence * 100);
      }
    }
    
    clearTimeout(silenceTimer);
    if (speechBuffer.trim()) {
      silenceTimer = setTimeout(() => {
        if (Date.now() - lastSpeechTime > 2000) {
          stopListening();
        }
      }, 2000);
    }
    
    const currentText = speechBuffer + interimTranscript;
    if (currentText.trim()) {
      updateSpeechStatus(`Recording: "${currentText.trim()}"`, 'info');
    }
  };
  
  state.recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    state.isListening = false;
    elements.speakBtn.classList.remove('listening-pulse');
    elements.listeningAnimation.classList.add('hidden');
    elements.speakBtnText.classList.remove('hidden');
    
    let errorMessage = 'Speech recognition error: ';
    switch(event.error) {
      case 'no-speech':
        errorMessage += 'No speech detected. Please try again.';
        break;
      case 'audio-capture':
        errorMessage += 'Microphone not accessible.';
        break;
      case 'not-allowed':
        errorMessage += 'Microphone permission denied.';
        break;
      default:
        errorMessage += 'Please try again.';
    }
    
    updateSpeechStatus(errorMessage, 'error');
    resetSpeechButton();
  };
  
  state.recognition.onend = () => {
    state.isListening = false;
    elements.speakBtn.classList.remove('listening-pulse');
    elements.listeningAnimation.classList.add('hidden');
    elements.speakBtnText.classList.remove('hidden');
    
    if (speechBuffer.trim() && state.interviewActive) {
      submitUserResponse(speechBuffer.trim());
      speechBuffer = '';
    } else {
      resetSpeechButton();
    }
  };
}

// Confidence Meter
function updateConfidenceMeter(confidence) {
  if (!elements.confidenceMeter.classList.contains('hidden')) {
    state.currentConfidence = confidence;
    elements.confidenceBar.style.width = `${confidence}%`;
    elements.confidencePercentage.textContent = `${Math.round(confidence)}%`;
  }
}

// AI Interaction
async function submitUserResponse(userInput) {
  if (!userInput.trim() || state.awaitingResponse) return;
  
  state.awaitingResponse = true;
  state.lastUserResponse = userInput;
  
  try {
    showLoadingOverlay('Processing your response...');
    updateInterviewStatus('Processing', 'bg-yellow-500');
    updateSpeechStatus('Processing your response...', 'info');
    
    addMessageToChat('user', userInput);
    
    state.totalResponses++;
    state.totalWords += userInput.split(' ').length;
    updateProgress();
    
    const response = await fetch(`/mock-interview/${state.sessionId}/ai_interaction/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_response: userInput,
        chat_history: state.chatHistory,
        request_type: 'normal'
      })
    });
    
    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      addMessageToChat('assistant', data.ai_response_text);
      
      if (data.ai_audio_url) {
        await playAIResponse(data.ai_response_text, data.ai_audio_url);
      }
      
      if (data.interview_progress) {
        state.currentQuestion = data.interview_progress.current_question;
        updateProgress();
      }
      
      if (data.interview_complete) {
        handleInterviewCompletion();
      } else {
        resetSpeechButton();
        elements.hintsBtn.classList.remove('hidden');
      }
      
      state.consecutiveErrors = 0;
      
    } else {
      throw new Error(data.error || 'Unknown error occurred');
    }
    
  } catch (error) {
    console.error('AI interaction failed:', error);
    handleInteractionError(error);
  } finally {
    state.awaitingResponse = false;
    hideLoadingOverlay();
  }
}

// Chat Functions
function addMessageToChat(role, message, autoScroll = true) {
  if (elements.chatEmpty && !elements.chatEmpty.classList.contains('hidden')) {
    elements.chatEmpty.classList.add('hidden');
  }
  
  const messageElement = document.createElement('div');
  messageElement.className = `mb-4 animate-pulse`;
  
  if (role === 'user') {
    messageElement.innerHTML = `
      <div class="flex justify-end">
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl rounded-br-md px-4 py-3 max-w-xs lg:max-w-sm shadow-lg">
          <div class="font-medium mb-1 text-sm opacity-80">You</div>
          <div class="text-sm leading-relaxed">${message}</div>
        </div>
      </div>
    `;
  } else {
    messageElement.innerHTML = `
      <div class="flex justify-start">
        <div class="glass-card text-white rounded-2xl rounded-bl-md px-4 py-3 max-w-xs lg:max-w-sm border border-white/20">
          <div class="font-medium mb-1 text-sm text-purple-300 flex items-center">
            <i class="fas fa-robot mr-2"></i>Sarah
          </div>
          <div class="text-sm leading-relaxed">${message}</div>
        </div>
      </div>
    `;
  }
  
  // Add to chat history
  state.chatHistory.push({ role: role === 'user' ? 'user' : 'assistant', content: message });
  
  elements.chatMessages.appendChild(messageElement);
  
  if (autoScroll) {
    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
  }
  
  // Remove animation after it completes
  setTimeout(() => messageElement.classList.remove('animate-pulse'), 400);
}

// Audio Playback
async function playAIResponse(text, audioUrl) {
  try {
    updateInterviewStatus('AI Speaking', 'bg-blue-500');
    elements.aiAvatar.classList.add('pulse-ring');
    elements.aiStatusText.innerHTML = '<i class="fas fa-volume-up mr-2"></i><span>Speaking...</span>';
    
    state.isPlaying = true;
    elements.aiAudioElement.src = audioUrl;
    elements.aiAudioElement.volume = state.currentVolume;
    
    await elements.aiAudioElement.play();
    
    elements.aiAudioElement.onended = () => {
      state.isPlaying = false;
      elements.aiAvatar.classList.remove('pulse-ring');
      elements.aiStatusText.innerHTML = '<i class="fas fa-brain mr-2"></i><span>Ready to Interview</span>';
      updateInterviewStatus('Interview Active', 'bg-green-500');
    };
    
  } catch (error) {
    console.error('Audio playback failed:', error);
    state.isPlaying = false;
    elements.aiAvatar.classList.remove('pulse-ring');
    elements.aiStatusText.innerHTML = '<i class="fas fa-brain mr-2"></i><span>Ready to Interview</span>';
    updateInterviewStatus('Interview Active', 'bg-green-500');
    showNotification('Audio playback failed. Check your connection.', 'warning');
  }
}

// Interview Control Functions
async function startInterview() {
  try {
    elements.startBtn.disabled = true;
    showLoadingOverlay('Preparing interview environment...');
    
    const mediaSetup = await setupMediaDevices();
    if (!mediaSetup) {
      elements.startBtn.disabled = false;
      return;
    }
    
    const response = await fetch(`/mock-interview/${state.sessionId}/start/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        resume_session: INTERVIEW_PROGRESS && INTERVIEW_PROGRESS.in_progress
      })
    });
    
    if (!response.ok) {
      throw new Error(`Failed to start interview: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      state.interviewActive = true;
      state.startTime = Date.now();
      state.currentQuestion = data.current_question || 1;
      
      updateInterviewStatus('Interview Active', 'bg-green-500');
      elements.startBtn.classList.add('hidden');
      elements.pauseBtn.classList.remove('hidden');
      elements.speakBtn.disabled = false;
      elements.recordingIndicator.classList.remove('hidden');
      elements.confidenceMeter.classList.remove('hidden');
      
      state.progressTimer = setInterval(updateProgress, 1000);
      
      if (data.ai_response_text) {
        addMessageToChat('assistant', data.ai_response_text);
        
        if (data.ai_audio_url) {
          await playAIResponse(data.ai_response_text, data.ai_audio_url);
        }
      }
      
      hideLoadingOverlay();
      showNotification('Interview started successfully! Good luck!', 'success');
      
      elements.hintsBtn.classList.remove('hidden');
      
      setTimeout(() => elements.speakBtn.focus(), 500);
      
    } else {
      throw new Error(data.error || 'Failed to start interview');
    }
    
  } catch (error) {
    console.error('Failed to start interview:', error);
    hideLoadingOverlay();
    elements.startBtn.disabled = false;
    showNotification(`Failed to start interview: ${error.message}`, 'error', 8000);
    updateInterviewStatus('Ready to Start', 'bg-green-500');
  }
}

async function endInterview() {
  if (!confirm('Are you sure you want to end the interview? This action cannot be undone.')) {
    return;
  }
  
  try {
    showLoadingOverlay('Ending interview...');
    
    const response = await fetch(`/mock-interview/${state.sessionId}/ai_interaction/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_response: '',
        chat_history: state.chatHistory,
        request_type: 'end_interview'
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.interview_complete) {
        handleInterviewCompletion();
        return;
      }
    }
    
    // Fallback if API call fails
    handleInterviewCompletion();
    
  } catch (error) {
    console.error('Failed to end interview properly:', error);
    handleInterviewCompletion(); // Still end the interview
  } finally {
    hideLoadingOverlay();
  }
}

function pauseInterview() {
  state.isPaused = !state.isPaused;
  
  if (state.isPaused) {
    if (state.progressTimer) clearInterval(state.progressTimer);
    if (state.isListening) stopListening();
    if (state.isPlaying) elements.aiAudioElement.pause();
    
    elements.pauseBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
    elements.speakBtn.disabled = true;
    updateInterviewStatus('Paused', 'bg-yellow-500');
    showNotification('Interview paused', 'info', 3000);
  } else {
    state.progressTimer = setInterval(updateProgress, 1000);
    elements.pauseBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
    elements.speakBtn.disabled = false;
    updateInterviewStatus('Interview Active', 'bg-green-500');
    showNotification('Interview resumed', 'info', 3000);
  }
}

function skipQuestion() {
  if (!state.interviewActive || state.awaitingResponse) return;
  
  if (confirm('Are you sure you want to skip this question?')) {
    submitUserResponse('I would like to skip this question and move to the next one.');
  }
}

// Speech Control Functions
function toggleListening() {
  if (state.isListening) {
    stopListening();
  } else {
    startListening();
  }
}

function startListening() {
  if (!state.recognition || !state.interviewActive || state.isPaused) {
    updateSpeechStatus('Speech recognition not available', 'error');
    return;
  }
  
  try {
    state.recognition.start();
    elements.stopSpeakBtn.classList.remove('hidden');
    elements.skipBtn.classList.remove('hidden');
  } catch (error) {
    console.error('Failed to start listening:', error);
    updateSpeechStatus('Failed to start voice recognition', 'error');
  }
}

function stopListening() {
  if (state.recognition && state.isListening) {
    state.recognition.stop();
  }
  elements.stopSpeakBtn.classList.add('hidden');
  elements.skipBtn.classList.add('hidden');
}

function resetSpeechButton() {
  elements.speakBtn.classList.remove('listening-pulse');
  elements.listeningAnimation.classList.add('hidden');
  elements.speakBtnText.classList.remove('hidden');
  elements.speakBtn.disabled = !state.interviewActive || state.isPaused;
  elements.stopSpeakBtn.classList.add('hidden');
  elements.skipBtn.classList.add('hidden');
  
  updateInterviewStatus(state.interviewActive ? 'Interview Active' : 'Ready to Start', 'bg-green-500');
}

// Hints System
async function loadInterviewHints() {
  try {
    elements.hintsContent.innerHTML = `
      <div class="glass-card p-4 rounded-lg border border-yellow-400/30">
        <div class="text-lg font-bold text-yellow-400 mb-2">Loading personalized hints...</div>
        <div class="text-gray-300">Analyzing your current question context for strategic guidance.</div>
      </div>
    `;
    
    const response = await fetch(`/mock-interview/${state.sessionId}/hints/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        current_question: state.currentQuestion,
        chat_history: state.chatHistory,
        session_context: {
          total_responses: state.totalResponses,
          average_confidence: state.currentConfidence
        }
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      displayHints(data.hints || getDefaultHints());
    } else {
      displayHints(getDefaultHints());
    }
  } catch (error) {
    console.error('Failed to load hints:', error);
    displayHints(getDefaultHints());
  }
}

function displayHints(hints) {
  elements.hintsContent.innerHTML = '';
  
  hints.forEach((hint, index) => {
    const hintElement = document.createElement('div');
    hintElement.className = 'glass-card p-4 rounded-lg border border-yellow-400/30 mb-4 last:mb-0';
    hintElement.innerHTML = `
      <div class="text-lg font-bold text-yellow-400 mb-2">${hint.title}</div>
      <div class="text-gray-300 leading-relaxed">${hint.description}</div>
    `;
    elements.hintsContent.appendChild(hintElement);
  });
}

function getDefaultHints() {
  return [
    {
      title: "Use the STAR Method",
      description: "Structure your answers with Situation, Task, Action, and Result to provide comprehensive responses that showcase your experience effectively."
    },
    {
      title: "Be Specific and Quantifiable",
      description: "Include concrete examples, numbers, and measurable outcomes whenever possible. This demonstrates real impact and achievement."
    },
    {
      title: "Show Your Thought Process",
      description: "Explain how you approach problems and make decisions. Interviewers want to understand your reasoning and analytical skills."
    },
    {
      title: "Connect to the Role",
      description: "Relate your experiences and skills directly to the position you're applying for. Show how your background makes you an ideal fit."
    }
  ];
}

function showHintsModal() {
  elements.hintsModal.classList.remove('hidden');
  setTimeout(() => {
    elements.hintsModalContent.classList.remove('scale-95', 'opacity-0');
    elements.hintsModalContent.classList.add('scale-100', 'opacity-100');
  }, 50);
  
  loadInterviewHints();
}

function hideHintsModal() {
  elements.hintsModalContent.classList.remove('scale-100', 'opacity-100');
  elements.hintsModalContent.classList.add('scale-95', 'opacity-0');
  
  setTimeout(() => {
    elements.hintsModal.classList.add('hidden');
  }, 300);
}

// Utility Functions for Loading and Error Handling
function showLoadingOverlay(message) {
  elements.loadingText.textContent = message;
  elements.loadingOverlay.classList.remove('hidden');
}

function hideLoadingOverlay() {
  elements.loadingOverlay.classList.add('hidden');
}

function handleInteractionError(error) {
  state.consecutiveErrors++;
  console.error('Interaction error:', error);
  
  if (state.consecutiveErrors < state.maxRetries) {
    showNotification(`Error occurred. Retrying... (${state.consecutiveErrors}/${state.maxRetries})`, 'warning', 5000);
    setTimeout(() => {
      resetSpeechButton();
    }, 2000);
  } else {
    showNotification('Multiple errors occurred. Please refresh the page or try again later.', 'error', 10000);
    updateSpeechStatus('Multiple errors detected. Please refresh the page.', 'error');
  }
}

function handleInterviewCompletion() {
  state.interviewComplete = true;
  state.interviewActive = false;
  
  if (state.progressTimer) clearInterval(state.progressTimer);
  if (state.recognition && state.isListening) state.recognition.stop();
  if (state.mediaStream) {
    state.mediaStream.getTracks().forEach(track => track.stop());
  }
  
  updateInterviewStatus('Completed', 'bg-blue-500');
  elements.speakBtn.disabled = true;
  elements.hintsBtn.classList.add('hidden');
  elements.recordingIndicator.classList.add('hidden');
  
  setTimeout(() => {
    window.location.href = `/mock-interview/${state.sessionId}/review/`;
  }, 2000);
  
  showNotification('Interview completed! Redirecting to review page...', 'success', 3000);
}

// Event Listeners Setup
function setupEventListeners() {
  elements.startBtn.addEventListener('click', startInterview);
  elements.endBtn.addEventListener('click', endInterview);
  elements.pauseBtn.addEventListener('click', pauseInterview);
  
  elements.speakBtn.addEventListener('click', toggleListening);
  elements.stopSpeakBtn.addEventListener('click', stopListening);
  elements.skipBtn.addEventListener('click', skipQuestion);
  
  elements.testAudioBtn.addEventListener('click', testAudio);
  elements.volumeSlider.addEventListener('input', updateVolume);
  
  elements.hintsBtn.addEventListener('click', showHintsModal);
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (event) => {
    if (!state.interviewActive) return;
    
    if (event.code === 'Space' && !event.target.matches('input, textarea')) {
      event.preventDefault();
      toggleListening();
    }
    
    if (event.code === 'Escape' && state.isListening) {
      event.preventDefault();
      stopListening();
    }
  });
  
  // Handle page unload
  window.addEventListener('beforeunload', (event) => {
    if (state.interviewActive && !state.interviewComplete) {
      event.preventDefault();
      event.returnValue = 'Your interview is still in progress. Are you sure you want to leave?';
      return event.returnValue;
    }
  });
}

// Initialize Visualizer
function initializeVisualizer() {
  const canvas = elements.visualizerCanvas;
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  const particles = [];
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      size: Math.random() * 2 + 1,
      opacity: Math.random() * 0.5 + 0.1
    });
  }
  
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(particle => {
      particle.x += particle.vx;
      particle.y += particle.vy;
      
      if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
      if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;
      
      ctx.beginPath();
      ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(147, 51, 234, ${particle.opacity})`;
      ctx.fill();
    });
    
    state.visualizerAnimationId = requestAnimationFrame(animate);
  }
  
  animate();
}

// Main Initialization Function
async function initializeInterface() {
  try {
    console.log('Initializing MockMate Professional Interview System...');
    
    setupEventListeners();
    updateVolume();
    
    
    updateProgress();
    initializeVisualizer();
    
    if (INTERVIEW_PROGRESS && INTERVIEW_PROGRESS.in_progress) {
      elements.startBtn.innerHTML = '<i class="fas fa-play mr-2"></i><span>Resume Interview</span>';
      updateInterviewStatus('Ready to Resume', 'bg-yellow-500');
      updateSpeechStatus('Click "Resume Interview" to continue your session', 'info');
      state.currentQuestion = INTERVIEW_PROGRESS.current_question || 1;
    }
    
    try {
      state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    } catch (e) {
      console.warn('AudioContext not supported:', e);
    }
    
    // Handle window resize for visualizer canvas
    window.addEventListener('resize', debounce(() => {
      if (elements.visualizerCanvas) {
        elements.visualizerCanvas.width = elements.visualizerCanvas.offsetWidth;
        elements.visualizerCanvas.height = elements.visualizerCanvas.offsetHeight;
      }
    }, 250));
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && state.isListening) {
        console.log('Page hidden, stopping speech recognition');
        stopListening();
      }
    });
    
    state.isInitialized = true;
    console.log('MockMate Professional Interview System initialized successfully');
    
    updateInterviewStatus('Ready to Start', 'bg-green-500');
    updateSpeechStatus('Click "Start Interview" to begin your session', 'info');
    
    // Show initial notification
    setTimeout(() => {
      showNotification('MockMate Interview System ready! Click "Start Interview" when you\'re prepared.', 'info', 4000);
    }, 1000);
    
  } catch (error) {
    console.error('Interface initialization failed:', error);
    showNotification('Failed to initialize interview system. Some features may not work properly.', 'error', 10000);
    state.isInitialized = true;
  }
}

// Cleanup function for when page is unloaded
function cleanup() {
  if (state.progressTimer) {
    clearInterval(state.progressTimer);
  }
  
  if (state.visualizerAnimationId) {
    cancelAnimationFrame(state.visualizerAnimationId);
  }
  
  if (state.mediaStream) {
    state.mediaStream.getTracks().forEach(track => track.stop());
  }
  
  if (state.recognition && state.isListening) {
    state.recognition.stop();
  }
  
  if (state.audioCtx && state.audioCtx.state !== 'closed') {
    state.audioCtx.close();
  }
}

// Additional utility functions
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function generateSessionReport() {
  const duration = state.startTime ? Math.floor((Date.now() - state.startTime) / 1000) : 0;
  const avgConfidence = state.metrics?.confidenceScores?.length > 0 ? 
    state.metrics.confidenceScores.reduce((a, b) => a + b) / state.metrics.confidenceScores.length : 0;
  
  return {
    sessionId: state.sessionId,
    duration: formatTime(duration),
    questionsAsked: state.currentQuestion,
    totalResponses: state.totalResponses,
    averageWordsPerResponse: state.totalResponses > 0 ? Math.round(state.totalWords / state.totalResponses) : 0,
    averageConfidence: Math.round(avgConfidence),
    chatHistory: state.chatHistory,
    timestamp: new Date().toISOString()
  };
}

// Enhanced error recovery
function attemptRecovery() {
  console.log('Attempting system recovery...');
  
  // Reset error counter
  state.consecutiveErrors = 0;
  
  // Reset UI elements
  resetSpeechButton();
  updateInterviewStatus(state.interviewActive ? 'Interview Active' : 'Ready to Start', 'bg-green-500');
  
  // Re-enable controls
  if (state.interviewActive) {
    elements.speakBtn.disabled = false;
    elements.hintsBtn.classList.remove('hidden');
  }
  
  showNotification('System recovered successfully. You can continue your interview.', 'success', 3000);
}

// Performance monitoring
function logPerformanceMetrics() {
  if (typeof performance !== 'undefined' && performance.mark) {
    performance.mark('interview-system-ready');
    
    const entries = performance.getEntriesByType('measure');
    if (entries.length > 0) {
      console.log('Performance metrics:', entries.map(entry => ({
        name: entry.name,
        duration: Math.round(entry.duration) + 'ms'
      })));
    }
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  console.log('Initializing MockMate Professional Interview System...');
  
  // Mark start time for performance monitoring
  if (typeof performance !== 'undefined' && performance.mark) {
    performance.mark('interview-init-start');
  }
  
  try {
    initializeInterface();
    logPerformanceMetrics();
  } catch (error) {
    console.error('Failed to initialize interface:', error);
    showNotification('Failed to initialize interview interface. Please refresh the page.', 'error');
  }
});

// Handle page unload
window.addEventListener('beforeunload', (event) => {
  cleanup();
  
  if (state.interviewActive && !state.interviewComplete) {
    event.preventDefault();
    event.returnValue = 'Your interview is still in progress. Are you sure you want to leave?';
    return event.returnValue;
  }
});

// Global functions for modal control (called from HTML)
window.hideHintsModal = hideHintsModal;
window.showHintsModal = showHintsModal;

// Expose utility functions for debugging
if (typeof window !== 'undefined') {
  window.MockMateDebug = {
    state,
    generateSessionReport,
    attemptRecovery,
    logPerformanceMetrics,
    resetSystem: () => {
      cleanup();
      location.reload();
    }
  };
}

// Service Worker registration for PWA capabilities (optional)
if ('serviceWorker' in navigator && 'production' === '{{ settings.ENVIRONMENT }}') {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => console.log('SW registered:', registration))
      .catch(registrationError => console.log('SW registration failed:', registrationError));
  });
}

</script>
{% endblock %}