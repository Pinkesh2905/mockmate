{% extends "base.html" %}
{% load static %}

{% block title %}New Discussion | {{ problem.title }} | MockMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
<style>
  /* Custom styles for the Monaco editor container */
  #code-editor {
    width: 100%;
    height: 256px;
    border-radius: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
  <div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex items-center space-x-4 mb-4">
        <a href="{% url 'practice:problem_discussions' problem.slug %}" 
           class="text-gray-500 hover:text-gray-700 transition duration-200">
          <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">New Discussion</h1>
          <p class="text-gray-600 mt-1">
            Problem: <a href="{% url 'practice:problem_detail' problem.slug %}" 
                       class="text-blue-600 font-semibold hover:underline">{{ problem.title }}</a>
          </p>
        </div>
      </div>

      <!-- Problem Info -->
      <div class="flex flex-wrap items-center gap-4">
        <span class="px-3 py-1 rounded-full text-sm font-semibold
          {% if problem.difficulty == 'EASY' %}bg-emerald-100 text-emerald-800
          {% elif problem.difficulty == 'MEDIUM' %}bg-amber-100 text-amber-800
          {% elif problem.difficulty == 'HARD' %}bg-rose-100 text-rose-800
          {% else %}bg-gray-100 text-gray-800{% endif %}">
          {{ problem.get_difficulty_display }}
        </span>

        {% if problem.category %}
          <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
            <i class="fas fa-tag mr-1"></i>{{ problem.category.name }}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-xl shadow-lg p-8">
      <form method="post" id="discussion-form">
        {% csrf_token %}
        
        <!-- Discussion Type -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-3">Discussion Type</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="relative">
              <input type="radio" id="question" name="is_solution" value="false" 
                     class="peer hidden" checked onchange="updateDiscussionType()">
              <label for="question" 
                     class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 transition duration-200">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                  <i class="fas fa-question-circle text-blue-600 text-xl"></i>
                </div>
                <div>
                  <div class="font-semibold text-gray-900">Question</div>
                  <div class="text-sm text-gray-600">Ask for help or clarification</div>
                </div>
              </label>
            </div>

            <div class="relative">
              <input type="radio" id="solution" name="is_solution" value="true" 
                     class="peer hidden" onchange="updateDiscussionType()">
              <label for="solution" 
                     class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 peer-checked:border-green-500 peer-checked:bg-green-50 transition duration-200">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                  <i class="fas fa-lightbulb text-green-600 text-xl"></i>
                </div>
                <div>
                  <div class="font-semibold text-gray-900">Solution</div>
                  <div class="text-sm text-gray-600">Share your approach or solution</div>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Title -->
        <div class="mb-6">
          <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
            Title <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 id="title" 
                 name="title" 
                 required
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                 placeholder="Enter a descriptive title for your discussion">
          <div class="mt-2 text-sm text-gray-500">
            <span id="title-suggestions">
              <!-- Suggestions will be populated by JavaScript -->
            </span>
          </div>
        </div>

        <!-- Content -->
        <div class="mb-6">
          <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
            Content <span class="text-red-500">*</span>
          </label>
          <div class="border border-gray-300 rounded-lg overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-gray-50 border-b border-gray-300 p-2 flex items-center space-x-2">
              <button type="button" onclick="formatText('bold')" 
                      class="p-2 hover:bg-gray-200 rounded transition duration-200" title="Bold">
                <i class="fas fa-bold"></i>
              </button>
              <button type="button" onclick="formatText('italic')" 
                      class="p-2 hover:bg-gray-200 rounded transition duration-200" title="Italic">
                <i class="fas fa-italic"></i>
              </button>
              <div class="w-px h-6 bg-gray-300"></div>
              <button type="button" onclick="insertList('ul')" 
                      class="p-2 hover:bg-gray-200 rounded transition duration-200" title="Bullet List">
                <i class="fas fa-list-ul"></i>
              </button>
              <button type="button" onclick="insertList('ol')" 
                      class="p-2 hover:bg-gray-200 rounded transition duration-200" title="Numbered List">
                <i class="fas fa-list-ol"></i>
              </button>
              <div class="w-px h-6 bg-gray-300"></div>
              <button type="button" onclick="insertLink()" 
                      class="p-2 hover:bg-gray-200 rounded transition duration-200" title="Insert Link">
                <i class="fas fa-link"></i>
              </button>
            </div>
            
            <textarea id="content" 
                      name="content" 
                      required
                      rows="8"
                      class="w-full p-4 border-0 focus:ring-0 resize-none"
                      placeholder="Describe your question, approach, or solution in detail..."></textarea>
          </div>
          <div class="mt-2 text-sm text-gray-500">
            You can use **bold**, *italic*, and [links](url) in your content.
          </div>
        </div>

        <!-- Code Snippet (Optional) -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-3">
            <label class="text-sm font-medium text-gray-700">
              Code Snippet (Optional)
            </label>
            <button type="button" onclick="toggleCodeEditor()" 
                    id="toggle-code-btn"
                    class="text-blue-600 text-sm hover:underline">
              Add Code
            </button>
          </div>

          <div id="code-section" class="hidden">
            <div class="mb-3">
              <select id="language" name="language" 
                      class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Language</option>
                <option value="python3">Python</option>
                <option value="cpp17">C++</option>
                <option value="java">Java</option>
                <option value="javascript">JavaScript</option>
                <option value="csharp">C#</option>
                <option value="go">Go</option>
                <option value="rust">Rust</option>
              </select>
            </div>
            
            <div id="code-editor" class="w-full h-64 border border-gray-300 rounded-lg"></div>
            <textarea id="code_snippet" name="code_snippet" class="hidden"></textarea>
          </div>
        </div>

        <!-- Tags -->
        <div class="mb-8">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Tags (Optional)
          </label>
          <div class="flex flex-wrap gap-2 mb-3" id="selected-tags">
            <!-- Selected tags will appear here -->
          </div>
          <input type="text" 
                 id="tag-input" 
                 placeholder="Type a tag and press Enter"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                 onkeypress="handleTagInput(event)">
          <input type="hidden" name="tags" id="tags-hidden">
          <div class="mt-2">
            <div class="text-sm text-gray-500 mb-2">Popular tags:</div>
            <div class="flex flex-wrap gap-2">
              <button type="button" onclick="addTag('algorithm')" 
                      class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full hover:bg-gray-200 transition duration-200">
                algorithm
              </button>
              <button type="button" onclick="addTag('data-structure')" 
                      class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full hover:bg-gray-200 transition duration-200">
                data-structure
              </button>
              <button type="button" onclick="addTag('optimization')" 
                      class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full hover:bg-gray-200 transition duration-200">
                optimization
              </button>
              <button type="button" onclick="addTag('time-complexity')" 
                      class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full hover:bg-gray-200 transition duration-200">
                time-complexity
              </button>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between">
          <a href="{% url 'practice:problem_discussions' problem.slug %}" 
             class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
            Cancel
          </a>
          
          <div class="space-x-3">
            <button type="submit" name="action" value="draft"
                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
              Save as Draft
            </button>
            <button type="submit" name="action" value="publish"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
              <i class="fas fa-paper-plane mr-2"></i>
              Post Discussion
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let editor;
  let codeEditorVisible = false;
  let selectedTags = new Set();

  // Initialize Monaco Editor for code
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' }});

  function toggleCodeEditor() {
    const codeSection = document.getElementById('code-section');
    const toggleBtn = document.getElementById('toggle-code-btn');
    
    codeEditorVisible = !codeEditorVisible;
    
    if (codeEditorVisible) {
      codeSection.classList.remove('hidden');
      toggleBtn.textContent = 'Remove Code';
      
      if (!editor) {
        require(['vs/editor/editor.main'], function() {
          editor = monaco.editor.create(document.getElementById('code-editor'), {
            value: '// Your code here\n',
            language: 'python',
            theme: 'vs-light',
            automaticLayout: true,
            minimap: { enabled: false },
            fontSize: 14,
            scrollBeyondLastLine: false,
            wordWrap: 'on',
            fontFamily: 'JetBrains Mono, Fira Code, monospace',
            lineNumbersMinChars: 3,
            padding: { top: 10, bottom: 10 },
            tabSize: 4,
            insertSpaces: true,
          });

          editor.onDidChangeModelContent(() => {
            document.getElementById('code_snippet').value = editor.getValue();
          });
        });
      }
    } else {
      codeSection.classList.add('hidden');
      toggleBtn.textContent = 'Add Code';
      document.getElementById('code_snippet').value = '';
    }
  }

  function updateDiscussionType() {
    const isSolution = document.getElementById('solution').checked;
    const titleSuggestions = document.getElementById('title-suggestions');
    
    if (isSolution) {
      titleSuggestions.innerHTML = `
        <strong>Suggestions:</strong> 
        "My approach using...", "Solution with O(n) complexity", "Alternative solution using..."
      `;
    } else {
      titleSuggestions.innerHTML = `
        <strong>Suggestions:</strong> 
        "Help with understanding...", "Confused about...", "Why does this approach fail?"
      `;
    }
  }

  function formatText(command) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let formattedText = '';
    if (command === 'bold') {
      formattedText = `**${selectedText}**`;
    } else if (command === 'italic') {
      formattedText = `*${selectedText}*`;
    }
    
    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + 2, start + 2 + selectedText.length);
  }

  function insertList(type) {
    const textarea = document.getElementById('content');
    const prefix = type === 'ul' ? '- ' : '1. ';
    const listItem = `\n${prefix}`;
    
    const start = textarea.selectionStart;
    textarea.value = textarea.value.substring(0, start) + listItem + textarea.value.substring(start);
    textarea.focus();
    textarea.setSelectionRange(start + listItem.length, start + listItem.length);
  }

  function insertLink() {
    const textarea = document.getElementById('content');
    const linkText = '[link text](url)';
    const start = textarea.selectionStart;
    
    textarea.value = textarea.value.substring(0, start) + linkText + textarea.value.substring(start);
    textarea.focus();
    textarea.setSelectionRange(start + 1, start + 10);
  }

  function handleTagInput(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      const input = event.target;
      const tag = input.value.trim().toLowerCase();
      
      if (tag && !selectedTags.has(tag)) {
        addTag(tag);
        input.value = '';
      }
    }
  }

  function addTag(tag) {
    if (selectedTags.has(tag)) return;
    
    selectedTags.add(tag);
    updateTagsDisplay();
    updateHiddenTagsInput();
  }

  function removeTag(tag) {
    selectedTags.delete(tag);
    updateTagsDisplay();
    updateHiddenTagsInput();
  }

  function updateTagsDisplay() {
    const container = document.getElementById('selected-tags');
    container.innerHTML = '';
    
    selectedTags.forEach(tag => {
      const tagElement = document.createElement('span');
      tagElement.className = 'inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full';
      tagElement.innerHTML = `
        ${tag}
        <button type="button" onclick="removeTag('${tag}')" class="ml-2 text-blue-600 hover:text-blue-800">
          <i class="fas fa-times text-xs"></i>
        </button>
      `;
      container.appendChild(tagElement);
    });
  }

  function updateHiddenTagsInput() {
    document.getElementById('tags-hidden').value = Array.from(selectedTags).join(',');
  }

  // Language change for code editor
  document.getElementById('language').addEventListener('change', function() {
    if (editor) {
      const langMap = {
        'python3': 'python',
        'cpp17': 'cpp',
        'java': 'java',
        'javascript': 'javascript',
        'csharp': 'csharp',
        'go': 'go',
        'rust': 'rust'
      };
      
      const monacoLang = langMap[this.value] || 'plaintext';
      monaco.editor.setModelLanguage(editor.getModel(), monaco.monaco.editor.create(document.getElementById('code-editor'), { value: '', language: monacoLang, theme: 'vs-light' }));
    }
  });

  // Initialize suggestions
  updateDiscussionType();
</script>
{% endblock %}
