{% extends "base.html" %}
{% load static %}

{% block title %}Discussions | {{ problem.title }} | MockMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
  <div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-4">
          <a href="{% url 'practice:problem_detail' problem.slug %}" 
             class="text-gray-500 hover:text-gray-700 transition duration-200">
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Discussions</h1>
            <p class="text-gray-600 mt-1">
              Problem: <a href="{% url 'practice:problem_detail' problem.slug %}" 
                         class="text-blue-600 font-semibold hover:underline">{{ problem.title }}</a>
            </p>
          </div>
        </div>

        <a href="{% url 'practice:create_discussion' problem.slug %}"
           class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
          <i class="fas fa-plus mr-2"></i>
          New Discussion
        </a>
      </div>

      <!-- Problem Info -->
      <div class="flex flex-wrap items-center gap-4">
        <span class="px-3 py-1 rounded-full text-sm font-semibold
          {% if problem.difficulty == 'EASY' %}bg-emerald-100 text-emerald-800
          {% elif problem.difficulty == 'MEDIUM' %}bg-amber-100 text-amber-800
          {% elif problem.difficulty == 'HARD' %}bg-rose-100 text-rose-800
          {% else %}bg-gray-100 text-gray-800{% endif %}">
          {{ problem.get_difficulty_display }}
        </span>

        {% if problem.category %}
          <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
            <i class="fas fa-tag mr-1"></i>{{ problem.category.name }}
          </span>
        {% endif %}

        {% if problem.companies %}
          <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-purple-100 text-purple-800">
            <i class="fas fa-building mr-1"></i>{{ problem.companies }}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-xl shadow-lg mb-6">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6 pt-6">
          <a href="?type=all" 
             class="py-2 px-1 font-medium text-sm border-b-2 transition duration-200
             {% if discussion_type == 'all' %}border-blue-600 text-blue-600{% else %}border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300{% endif %}">
            <i class="fas fa-comments mr-2"></i>
            All Discussions
          </a>
          <a href="?type=questions" 
             class="py-2 px-1 font-medium text-sm border-b-2 transition duration-200
             {% if discussion_type == 'questions' %}border-blue-600 text-blue-600{% else %}border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300{% endif %}">
            <i class="fas fa-question-circle mr-2"></i>
            Questions
          </a>
          <a href="?type=solutions" 
             class="py-2 px-1 font-medium text-sm border-b-2 transition duration-200
             {% if discussion_type == 'solutions' %}border-blue-600 text-blue-600{% else %}border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300{% endif %}">
            <i class="fas fa-lightbulb mr-2"></i>
            Solutions
          </a>
        </nav>
      </div>

      <div class="p-6">
        <div class="text-sm text-gray-600">
          {{ page_obj.paginator.count }} discussion{{ page_obj.paginator.count|pluralize }} found
        </div>
      </div>
    </div>

    <!-- Discussions List -->
    <div class="space-y-4">
      {% for discussion in page_obj %}
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 group">
          <div class="p-6">
            <div class="flex items-start space-x-4">
              <!-- User Avatar -->
              <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                  {{ discussion.user.username|first|upper }}
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center space-x-3">
                    <!-- Pinned Badge -->
                    {% if discussion.is_pinned %}
                      <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800">
                        <i class="fas fa-thumbtack mr-1"></i>Pinned
                      </span>
                    {% endif %}

                    <!-- Solution Badge -->
                    {% if discussion.is_solution %}
                      <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-lightbulb mr-1"></i>Solution
                      </span>
                    {% else %}
                      <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-question-circle mr-1"></i>Question
                      </span>
                    {% endif %}
                  </div>

                  <div class="text-sm text-gray-500">
                    {{ discussion.created_at|timesince }} ago
                  </div>
                </div>

                <h3 class="text-xl font-bold text-gray-900 mb-3 group-hover:text-blue-600 transition duration-200">
                  <a href="#" onclick="toggleDiscussion('{{ discussion.id }}')">
                    {{ discussion.title }}
                  </a>
                </h3>

                <div class="text-gray-700 mb-4 line-clamp-3">
                  {{ discussion.content|linebreaks|truncatewords:30 }}
                </div>

                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <!-- Author Info -->
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                      <span class="font-medium">{{ discussion.user.username }}</span>
                      {% if discussion.user.profile.role == 'TUTOR' %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                          <i class="fas fa-chalkboard-teacher mr-1"></i>Tutor
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Voting and Actions -->
                  <div class="flex items-center space-x-4">
                    <!-- Vote Buttons -->
                    <div class="flex items-center space-x-2">
                      <button onclick="voteDiscussion({{ discussion.id }}, 1)" 
                              class="flex items-center space-x-1 px-2 py-1 rounded-md hover:bg-green-50 transition duration-200 vote-btn"
                              data-discussion-id="{{ discussion.id }}" 
                              data-vote="1">
                        <i class="fas fa-thumbs-up text-green-600"></i>
                        <span class="text-sm font-medium text-green-600" id="upvotes-{{ discussion.id }}">{{ discussion.upvotes }}</span>
                      </button>

                      <button onclick="voteDiscussion({{ discussion.id }}, -1)" 
                              class="flex items-center space-x-1 px-2 py-1 rounded-md hover:bg-red-50 transition duration-200 vote-btn"
                              data-discussion-id="{{ discussion.id }}" 
                              data-vote="-1">
                        <i class="fas fa-thumbs-down text-red-600"></i>
                        <span class="text-sm font-medium text-red-600" id="downvotes-{{ discussion.id }}">{{ discussion.downvotes }}</span>
                      </button>
                    </div>

                    <button onclick="toggleDiscussion('{{ discussion.id }}')" 
                            class="flex items-center space-x-1 px-3 py-1 rounded-md text-blue-600 hover:bg-blue-50 transition duration-200">
                      <i class="fas fa-comment"></i>
                      <span class="text-sm font-medium">Discuss</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Expandable Content -->
            <div id="discussion-content-{{ discussion.id }}" class="hidden mt-6 border-t border-gray-200 pt-6">
              <div class="prose max-w-none">
                {{ discussion.content|linebreaks }}
              </div>

              {% if discussion.code_snippet %}
                <div class="mt-6">
                  <h4 class="text-lg font-semibold text-gray-800 mb-3">Code Snippet</h4>
                  <div class="bg-gray-900 rounded-lg overflow-hidden">
                    <div class="bg-gray-800 px-4 py-2 text-sm text-gray-300 font-mono">
                      {{ discussion.language|default:"Code" }}
                    </div>
                    <pre class="p-4 text-sm text-gray-100 overflow-x-auto"><code>{{ discussion.code_snippet }}</code></pre>
                  </div>
                </div>
              {% endif %}

              <!-- Comments Section (placeholder) -->
              <div class="mt-6 bg-gray-50 rounded-lg p-4">
                <div class="text-center text-gray-500">
                  <i class="fas fa-comments text-2xl mb-2"></i>
                  <p>Comments feature coming soon</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="bg-white rounded-xl shadow-lg p-12 text-center">
          <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
            <i class="fas fa-comments text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No discussions yet</h3>
          <p class="text-gray-500 mb-6">Be the first to start a discussion about this problem</p>
          <a href="{% url 'practice:create_discussion' problem.slug %}"
             class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
            <i class="fas fa-plus mr-2"></i>
            Start Discussion
          </a>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
        <nav class="flex items-center justify-between">
          <div class="flex items-center">
            <p class="text-sm text-gray-700">
              Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} discussions
            </p>
          </div>
          
          <div class="flex items-center space-x-2">
            {% if page_obj.has_previous %}
              <a href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}page={{ page_obj.previous_page_number }}"
                 class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition duration-200">
                <i class="fas fa-chevron-left mr-1"></i>Previous
              </a>
            {% endif %}

            <div class="hidden md:flex space-x-1">
              {% for page_num in page_obj.paginator.page_range %}
                {% if page_num == page_obj.number %}
                  <span class="px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg">
                    {{ page_num }}
                  </span>
                {% elif page_num > page_obj.number|add:-3 and page_num < page_obj.number|add:3 %}
                  <a href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}page={{ page_num }}"
                     class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition duration-200">
                    {{ page_num }}
                  </a>
                {% endif %}
              {% endfor %}
            </div>

            {% if page_obj.has_next %}
              <a href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}page={{ page_obj.next_page_number }}"
                 class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition duration-200">
                Next<i class="fas fa-chevron-right ml-1"></i>
              </a>
            {% endif %}
          </div>
        </nav>
      </div>
    {% endif %}
  </div>
</div>

<script>
  function toggleDiscussion(discussionId) {
    const contentDiv = document.getElementById(`discussion-content-${discussionId}`);
    if (contentDiv.classList.contains('hidden')) {
      contentDiv.classList.remove('hidden');
    } else {
      contentDiv.classList.add('hidden');
    }
  }

  function voteDiscussion(discussionId, voteValue) {
    fetch(`{% url 'practice:vote_discussion' 0 %}`.replace('0', discussionId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        'vote': voteValue
      })
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById(`upvotes-${discussionId}`).textContent = data.upvotes;
      document.getElementById(`downvotes-${discussionId}`).textContent = data.downvotes;
      
      // Update button states based on user vote
      const upBtn = document.querySelector(`button[data-discussion-id="${discussionId}"][data-vote="1"]`);
      const downBtn = document.querySelector(`button[data-discussion-id="${discussionId}"][data-vote="-1"]`);
      
      // Reset button states
      upBtn.classList.remove('bg-green-100');
      downBtn.classList.remove('bg-red-100');
      
      // Highlight current vote
      if (data.user_vote === 1) {
        upBtn.classList.add('bg-green-100');
      } else if (data.user_vote === -1) {
        downBtn.classList.add('bg-red-100');
      }
    })
    .catch(error => {
      console.error('Error voting:', error);
    });
  }
</script>
{% endblock %}
