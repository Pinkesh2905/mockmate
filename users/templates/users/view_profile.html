{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ user_profile.user.get_full_name|default:user_profile.user.username }}'s Profile{% endblock %}

{% block content %}
<div class="min-h-screen container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Profile Header Card -->
    <div class="bg-gray-900/50 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl overflow-hidden">
        <!-- Banner Image -->
        <div class="h-48 bg-gradient-to-r from-cyan-500/30 to-blue-600/30">
            <!-- A placeholder for a future banner image feature -->
        </div>

        <div class="p-6 sm:p-8">
            <!-- Avatar and Actions -->
            <div class="flex flex-col sm:flex-row items-center sm:items-end -mt-24 sm:-mt-20 sm:space-x-6">
                <div class="relative">
                    {% if user_profile.avatar %}
                        <img class="h-32 w-32 rounded-full object-cover ring-4 ring-gray-800 shadow-lg" src="{{ user_profile.avatar.url }}" alt="{{ user_profile.user.username }}'s avatar">
                    {% else %}
                        <div class="h-32 w-32 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold text-5xl ring-4 ring-gray-800 shadow-lg">
                            {{ user_profile.user.username|first|upper }}
                        </div>
                    {% endif %}
                    <!-- Online Status Indicator -->
                    <span class="absolute bottom-2 right-2 block h-5 w-5 rounded-full bg-green-500 border-2 border-gray-800" title="Online"></span>
                </div>
                
                <div class="flex-grow mt-4 sm:mt-0 text-center sm:text-left">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-100">
                        {{ user_profile.user.get_full_name|default:user_profile.user.username }}
                    </h1>
                    <p class="text-md text-gray-400">@{{ user_profile.user.username }}</p>
                </div>
                
                <div class="mt-4 sm:mt-0">
                    {% if is_own_profile %}
                        <a href="{% url 'users:profile' %}" class="px-5 py-2.5 bg-white/10 hover:bg-white/20 border border-white/20 text-white font-semibold rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 text-sm flex items-center gap-2">
                           <i class="ri-settings-3-line"></i> Edit Profile
                        </a>
                    {% else %}
                         <button class="px-6 py-2.5 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white font-bold rounded-full shadow-lg hover:shadow-cyan-500/50 transform hover:scale-105 transition-all duration-300 text-sm flex items-center gap-2">
                            <i class="ri-user-follow-line"></i> Follow
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Bio -->
            <div class="mt-6 text-center sm:text-left max-w-2xl">
                <p class="text-gray-300 leading-relaxed">{{ user_profile.bio|default:"This user hasn't set a bio yet." }}</p>
            </div>

            <!-- Info -->
            <div class="mt-6 flex flex-wrap items-center justify-center sm:justify-start gap-x-6 gap-y-3 text-sm text-gray-400">
                <div class="flex items-center gap-1.5">
                    <i class="ri-calendar-line"></i>
                    <span>Joined {{ user_profile.created_at|date:"F Y" }}</span>
                </div>
                {% if user_profile.github %}
                    <a href="{{ user_profile.github }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1.5 hover:text-cyan-400 transition-colors">
                        <i class="ri-github-fill"></i>
                        <span>GitHub</span>
                    </a>
                {% endif %}
                {% if user_profile.linkedin %}
                    <a href="{{ user_profile.linkedin }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1.5 hover:text-cyan-400 transition-colors">
                        <i class="ri-linkedin-box-fill"></i>
                        <span>LinkedIn</span>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Main Content Grid -->
    <div class="mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Column: Additional Info -->
        <aside class="lg:col-span-4 xl:col-span-3">
             <div class="bg-gray-900/50 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-xl p-6 space-y-6 sticky top-8">
                <div>
                    <h3 class="font-bold text-gray-200 text-lg">Stats</h3>
                    <div class="mt-2 space-y-2 text-sm text-gray-300">
                        <p class="flex justify-between items-center">
                            <span class="flex items-center gap-2"><i class="ri-quill-pen-line"></i> Total Activity</span> 
                            <span class="font-semibold text-white bg-white/10 px-2 py-0.5 rounded-md">{{ user_posts|length }}</span>
                        </p>
                    </div>
                </div>
             </div>
        </aside>


        <!-- Right Column: Activity Feed -->
        <main class="lg:col-span-8 xl:col-span-9">
            <h2 class="text-2xl font-bold text-gray-100 mb-6">Timeline</h2>
            
            <div class="space-y-6">
                {% for post in user_posts %}
                    <div class="bg-gray-900/50 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-lg transition-all duration-300 hover:border-cyan-400/50 overflow-hidden">
                        <!-- Repost Header -->
                        {% if post.is_repost %}
                        <div class="px-5 pt-4 flex items-center text-sm text-gray-400">
                            <i class="ri-repeat-line mr-2"></i>
                            <a href="{% url 'users:public_profile' post.reposted_by.username %}" class="font-semibold text-gray-300 hover:text-cyan-400 mr-1">
                                {{ post.reposted_by.get_full_name|default:post.reposted_by.username }}
                            </a>
                            reposted
                        </div>
                        {% endif %}

                        <!-- Main Post Body -->
                        <div class="p-5">
                            <div class="flex items-start">
                                <!-- Avatar -->
                                <a href="{% url 'users:public_profile' post.author.username %}">
                                    {% if post.author.profile.avatar %}
                                        <img class="h-11 w-11 rounded-full object-cover mr-4 flex-shrink-0" src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.username }}'s avatar">
                                    {% else %}
                                         <div class="h-11 w-11 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg mr-4 flex-shrink-0">
                                             {{ post.author.username|first|upper }}
                                         </div>
                                    {% endif %}
                                </a>
                                <div class="w-full">
                                    <!-- Post Info -->
                                    <div class="flex items-baseline justify-between">
                                        <div class="flex items-baseline">
                                            <a href="{% url 'users:public_profile' post.author.username %}" class="font-bold text-gray-200 hover:text-cyan-400 transition-colors">{{ post.author.get_full_name|default:post.author.username }}</a>
                                            <span class="text-sm text-gray-500 ml-2">@{{ post.author.username }}</span>
                                        </div>
                                        <a href="{% url 'posts:post_detail' post.id %}" class="text-xs text-gray-500 hover:text-gray-300 transition-colors flex-shrink-0">{{ post.display_time|naturaltime }}</a>
                                    </div>
                                    <!-- Clickable Post Content -->
                                    <div class="cursor-pointer" onclick="openPostModal('{{ post.id }}')">
                                        <div class="prose prose-invert prose-sm text-gray-300 mt-2">
                                           <p>{{ post.content|linebreaksbr }}</p>
                                        </div>
                                        {% if post.image %}
                                            <div class="block mt-4 rounded-xl overflow-hidden border border-white/10 hover:border-white/20 transition-all">
                                                <img src="{{ post.image.url }}" class="w-full h-auto object-cover" alt="Post image">
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="bg-gray-900/50 backdrop-blur-2xl border border-dashed border-white/20 rounded-2xl p-12 text-center">
                        <div class="text-5xl mb-4 opacity-40">
                           <i class="ri-quill-pen-line"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-300">No Posts Yet</h3>
                        <p class="mt-1 text-sm text-gray-500">When this user shares a post, it will appear here.</p>
                    </div>
                {% endfor %}
            </div>
        </main>
    </div>
</div>

<!-- Post Modal Container -->
<div id="post-modal-container" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4" onclick="closePostModal(event)">
    <div id="post-modal-content" class="bg-gray-900/80 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <!-- Loading Spinner -->
        <div id="modal-loader" class="p-16 flex justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-white/20 border-t-cyan-400"></div>
        </div>
        <!-- Fetched Content will be injected here -->
    </div>
</div>

<script>
    const modalContainer = document.getElementById('post-modal-container');
    const modalContent = document.getElementById('post-modal-content');
    const modalLoader = document.getElementById('modal-loader');

    function openPostModal(postId) {
        // Show modal and loader
        modalContainer.classList.remove('hidden');
        modalContainer.classList.add('flex');
        modalLoader.style.display = 'flex';
        modalContent.innerHTML = ''; // Clear previous content
        modalContent.appendChild(modalLoader);

        // Fetch post content
        const baseUrl = `{% url 'posts:post_modal' '00000000-0000-0000-0000-000000000000' %}`;
        const url = baseUrl.replace('00000000-0000-0000-0000-000000000000', postId);
        
        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalLoader.style.display = 'none';
                modalContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Error fetching post modal:', error);
                modalContent.innerHTML = '<p class="text-red-400 p-8 text-center">Could not load post. Please try again.</p>';
            });
    }

    function closePostModal(event) {
        // Only close if the click is on the background container itself
        if (event.target === modalContainer) {
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
            modalContent.innerHTML = ''; // Clean up content
        }
    }
</script>
{% endblock %}

